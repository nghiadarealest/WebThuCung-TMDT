@{
    ViewData["Title"] = "Lá»‹ch sá»­ mua hÃ ng";
}
<link rel="stylesheet" href="/css/transactionHistory.css" />

<div class="order-history-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <button class="tab-button active" data-tab="payment-status">ğŸ›’ Lá»‹ch sá»­ mua hÃ ng</button>
        <button class="tab-button" data-tab="completed">âœ… HoÃ n thÃ nh</button>
        <button class="tab-button" data-tab="canceled">âŒ ÄÃ£ huá»·</button>
    </div>
    <!-- Content -->
    <div class="content">
        <div id="payment-status" class="tab-content active">
            <h4>ğŸ›’ Lá»‹ch sá»­ mua hÃ ng</h4>
            <div id="payment-orders" class="order-list"></div>
        </div>
        <div id="completed" class="tab-content">
            <h4>âœ… HoÃ n thÃ nh</h4>
            <div id="completed-orders" class="order-list"></div>
        </div>
        <div id="canceled" class="tab-content">
            <h4>âŒ ÄÃ£ huá»·</h4>
            <div id="canceled-orders" class="order-list"></div>
        </div>
    </div>
</div>

<script>
    // Láº¥y userId tá»« localStorage
    const userId = localStorage.getItem('id');
    // Kiá»ƒm tra náº¿u userId tá»“n táº¡i
    if (!userId) {
        console.error('userId khÃ´ng Ä‘Æ°á»£c tÃ¬m tháº¥y trong localStorage.');
        alert('Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ xem lá»‹ch sá»­ mua hÃ ng.');
        window.location.href = '/login'; // Chuyá»ƒn hÆ°á»›ng Ä‘áº¿n trang Ä‘Äƒng nháº­p
    }

    async function fetchOrders() {
        const response = await fetch(`https://localhost:5003/api/orders?userId=${userId}`);
        const data = await response.json();
        return data.data; // Tráº£ vá» máº£ng Ä‘Æ¡n hÃ ng
    }

    function renderOrders(orders, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = ''; // XÃ³a ná»™i dung cÅ©

    if (orders.length === 0) {
        container.innerHTML = '<p>KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o.</p>';
        return;
    }

    orders.forEach(order => {
        const isCancelable = order.status.toLowerCase() !== 'canceled' && order.status.toLowerCase() !== 'completed';
        const cancelButton = isCancelable ? `<button class="cancel-button" data-id="${order.orderId}">Há»§y Ä‘Æ¡n hÃ ng</button>` : '';

        const orderCard = `
            <div class="order-card" style="display: flex;align-items: center;justify-content: space-between;">
                <div>
                    <h3><strong>ÄÆ¡n hÃ ng #</strong>${order.orderId}</h3>
                    <p><strong>Tá»•ng tiá»n</strong>: ${(order.totalAmount * 1000).toLocaleString('vi-VN')} VNÄ</p>
                    <p><strong>NgÃ y Ä‘áº·t:</strong> ${new Date(order.orderDate).toLocaleString()}</p>
                    <p><strong>Tráº¡ng thÃ¡i:</strong> ${order.status}</p>
                </div>
                <div style="text-align: center;">${cancelButton}</div>
            </div>
        `;
        container.innerHTML += orderCard;
    });

    // ThÃªm sá»± kiá»‡n click cho nÃºt há»§y Ä‘Æ¡n hÃ ng
    document.querySelectorAll('.cancel-button').forEach(button => {
        button.addEventListener('click', () => {
            const orderId = button.getAttribute('data-id');
            if (confirm(`Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n há»§y Ä‘Æ¡n hÃ ng #${orderId}?`)) {
                cancelOrder(orderId);
            }
        });
    });
}
    async function cancelOrder(orderId) {
    try {
        const response = await fetch(`/api/orders/cancel?orderId=${orderId}`, {
            method: 'POST'
        });

        if (response.ok) {
            const result = await response.json();
            alert(result.message); // Hiá»ƒn thá»‹ thÃ´ng bÃ¡o thÃ nh cÃ´ng
            loadOrders(); // Táº£i láº¡i Ä‘Æ¡n hÃ ng Ä‘á»ƒ cáº­p nháº­t tráº¡ng thÃ¡i
        } else {
            const error = await response.json();
            alert(error.message); // Hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i
        }
    } catch (error) {
        console.error('Lá»—i khi há»§y Ä‘Æ¡n hÃ ng:', error);
        alert('ÄÃ£ cÃ³ lá»—i xáº£y ra khi há»§y Ä‘Æ¡n hÃ ng.');
    }
}   

    async function loadOrders(status = null) {
        const orders = await fetchOrders();
        const filteredOrders = status ? orders.filter(order => order.status.toLowerCase() === status.toLowerCase()) : orders;
        renderOrders(filteredOrders, status ? (status === 'completed' ? 'completed-orders' : 'canceled-orders') : 'payment-orders');
    }

    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', async () => {
            const tabId = button.getAttribute('data-tab');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            button.classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Táº£i Ä‘Æ¡n hÃ ng cho tráº¡ng thÃ¡i tÆ°Æ¡ng á»©ng
            if (tabId === 'payment-status') {
                await loadOrders(); // Táº£i táº¥t cáº£ Ä‘Æ¡n hÃ ng
            } else if (tabId === 'completed') {
                await loadOrders('completed'); // Táº£i Ä‘Æ¡n hÃ ng hoÃ n thÃ nh
            } else if (tabId === 'canceled') {
                await loadOrders('canceled'); // Táº£i Ä‘Æ¡n hÃ ng Ä‘Ã£ huá»·
            }
        });
    });

    // Táº£i dá»¯ liá»‡u cho tab "Lá»‹ch sá»­ mua hÃ ng" khi trang Ä‘Æ°á»£c náº¡p
    loadOrders();
</script>